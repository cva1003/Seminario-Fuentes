---
title: "¿Existe una relación entre las defunciones por enfermedad respiratoria, el tiempo meteorológico y la cantidad de zonas verdes?"
author: "Claudia Valentín, Nisrine Fariss, Jacinto Javier Perez"
date: "`r Sys.Date()`"
output: 
  html_document:
    fig_width: 16 
    fig_height: 6
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Indice de contenidos
1. Introducción
2. Objetivos
3. Conjunto de datos
4. Desarrollo y Resultados
5. Conclusiones finales

## 1.Introducción
La superficie de zonas verdes en España y en el mundo han ido disminuyendo, siendo sustiyuendo estas superficies por construcción de infraestructuras, carreteras, desarollo urbano, etc...

Estas zonas verdes ayudan a la eliminacion de gases atmosfericos, por lo que al eliminarlas o reducirlas percute en nuestra salud y ademas la cantidad de estas zonas influyen en la regulación del clima.

## 2.Objetivos
El objetivo principal de nuestro proyecto es determinar una posible relación entre las defunciones por enfermedades respiratorias y el medio ambiente.

Tambien vamos a comparar los resultados con la cantidad de centros de salud para contrastar si tambien es un problema por falta de medios sanitarios o solo medioambientales

## 3.Conjunto de datos
Hemos recogido datos de bases de datos diferentes, entre ellas encontramos la aemet, el ine, el ministerio de sanidad y el diario AS.

Vamos a trabajar con ellos en el formato .xlsx

## 4.Desarrollo y Resultados
En primer lugar, vamos a realizar una exposición principal de todos los datos recabados para luego modificarlos y trabajar con ellos.

**Importación de librerias**
```{r librerias, echo=TRUE, warning=FALSE, message=FALSE}

library(readxl)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(climaemet)
library(lubridate)
library(htmltools)
library(DT)
library(mapSpain)

```
### 4.1Datos de defunciones por enfermedades respiratorias
```{r defunciones, echo=TRUE}
defuncion <-read_excel("defunciones.xlsx")
defuncion_resp<-defuncion %>%
  slice(1337:1500)%>%
  select(1,3)%>%
  rename(Provincia = 1, defunciones= 2)
datatable(defuncion_resp)

```
#### 4.1.1 Datos de defunciones por enfermedades respiratorias total por Provincia
```{r defunciones total, echo=TRUE}
defuncion_resp_total<-defuncion_resp %>%
  slice(2:53)%>%
  select(1,2)
datatable(defuncion_resp_total)

```
#### 4.1.2 Datos de defunciones por enfermedades respiratorias mujeres por Provincia
```{r defunciones mujeres, echo=TRUE}
defuncion_resp_mujeres<-defuncion_resp %>%
  slice(112:163)%>%
  select(1,2)%>%
  rename(defunciones_mujeres= 2)
datatable(defuncion_resp_mujeres)
```
#### 4.1.3 Datos de defunciones por enfermedades respiratorias hombres por Provincia
```{r defunciones hombres, echo=TRUE}
defuncion_resp_hombres<-defuncion_resp %>%
  slice(57:108)%>%
  select(1,2)%>%
  rename(defunciones_hombres= 2)
datatable(defuncion_resp_hombres)
```

#### 4.1.4 Histograma de defunciones por enfermedades respiratorias de hombres y mujeres por Provincia
```{r combinar}
defuncion_resp_combinada <- merge(defuncion_resp_hombres, defuncion_resp_mujeres, by = "Provincia")
ggplot(defuncion_resp_combinada, aes(x = Provincia)) +
  geom_bar(aes(y = defunciones_hombres, fill = "Hombres"), position = "dodge", stat = "identity") +
  geom_bar(aes(y = defunciones_mujeres, fill = "Mujeres"), position = "dodge", stat = "identity") +
  labs(title = "Defunciones por enfermedades respiratorias por provincia",
       x = "Provincia",
       y = "Defunciones",
       fill = "Género") +
  scale_fill_manual(values = c("Hombres" = "white", "Mujeres" = "purple"))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  

```

### 4.2 Importación de datos de la cantidad de zonas verdes
```{r}
zonas_verdes <- read_excel("zonas_verdes.xlsx")
datatable(zonas_verdes)

```


### Porcentaje zonas verdes por provincia
```{r Mapa}
library(sf)
Provs <- esp_get_prov()%>%
  rename("Provincia"=ine.prov.name)
provincias<-st_as_sf(inner_join(y=Provs, x= zonas_verdes, by="Provincia"))
parques<- zonas_verdes$`Parques m²/hab`
Can <- esp_get_can_box()

ggplot(provincias) +
  geom_sf(aes(fill = parques),
    color = "grey70",
    linewidth = .3
  ) +
  geom_sf(data = Can, color = "grey70") +
  geom_sf_label(aes(label = parques),
    fill = "white", alpha = 0.5,
    size = 3,
    label.size = 0
  ) +
  scale_fill_gradientn(
    colors = hcl.colors(15, "Greens", rev = TRUE),
    n.breaks = 10,
    labels = function(x) {
      sprintf("%1.1f%%", 1 * x)
    },
    guide = guide_legend(title = "parques")
  ) +
  theme_void() +
  theme(legend.position = c(0.1, 0.6))



```
### 4.3 Número de hospitales por provincia.
```{r conteo por provincia}
datos <-read_excel("CNH_2021.xlsx")
conteo_por_provincia <- datos %>%
  group_by(Provincia) %>%
  summarize(Numero_Hospitales = n_distinct(`Nombre Centro`))
datatable(conteo_por_provincia)
```

#### 4.3.1 Gráfico de barras del número de hospitales por provincia

```{r}
conteo_por_provincia$Provincia <- substr(conteo_por_provincia$Provincia, 1,3)

ggplot(conteo_por_provincia, aes(x = Provincia, y = Numero_Hospitales)) +
  geom_segment(aes(x=Provincia, xend=Provincia, y=0, yend=Numero_Hospitales)) +
  geom_point( size=5, color="red", fill=alpha("orange", 0.3), alpha=0.7, shape=21, stroke=2) +
  labs(title = "Número de Hospitales por Provincia",
       x = "Provincia",
       y = "Número de Hospitales") +
  theme_minimal()

```

### 4.4 Lluvias por provincia
```{r Lluvias por provincia}
aemet_api_key("eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJjbGF1ZGlhdmFsZ3VAZ21haWwuY29tIiwianRpIjoiMTU3MmFlYmMtNDU0My00ZjJiLTgyYjgtY2M0NTI2NWY2YTNmIiwiaXNzIjoiQUVNRVQiLCJpYXQiOjE2OTkyNjIzMDUsInVzZXJJZCI6IjE1NzJhZWJjLTQ1NDMtNGYyYi04MmI4LWNjNDUyNjVmNmEzZiIsInJvbGUiOiIifQ.X2uwTqNh9qDeaoVJSlEgO4oCN_YpqRAVRlgxsV0BUtU",install=TRUE, overwrite = TRUE)
estaciones<- aemet_stations()
valores_unicos <- unique(estaciones$provincia)
datatable(estaciones)
```

```{r Lluvia por provincia, warning=FALSE, message=FALSE}
#datos climatogicos por cada estacion en cada provincia
data_monthlysi <- aemet_monthly_clim(station=estaciones$indicativo, year = 2020)
datatable(data_monthlysi)

```

```{r promedio provincias}
#promedio de lluvias por cada estacion
data_monthlyprom <- data_monthlysi %>%
  group_by(indicativo) %>%
  summarize(promedio_precipitacion = mean(p_mes, na.rm = TRUE))
datatable(data_monthlyprom)#son litros/m^2
```

### Asociacion a cada provincias
```{r Asociacion a cada provincias}
resultado <- left_join(data_monthlyprom, estaciones, by = "indicativo") %>%
  select(indicativo, provincia, everything())
datatable(resultado)
```

### Agrupacion por provincia
```{r Agrupacion por provincia}
# Seleccionar un rango de columnas
datos_interes <- resultado %>% group_by(provincia)%>%
  select(indicativo, provincia, altitud, promedio_precipitacion )
```


```{r obtencion datos para el grafico}
#obtencion datos para el grafico
datos_grafico<- datos_interes%>% group_by(provincia)%>%
summarize(altitu_media = mean(altitud, na.rm = TRUE),
    precip_total = sum(promedio_precipitacion, na.rm = TRUE))
datatable(datos_grafico)
```

### Grafico de precipitaciones
```{r Grafico de precipitaciones}
ggplot(datos_grafico, aes(x = reorder(provincia,-precip_total), y = precip_total, color = altitu_media)) +
  geom_point(size = 3) +
  scale_color_gradient(low = "blue", high = "red") +
  labs(title = "Precipitación y altitud por provincia",
       x = "Provincia",
       y = "Precipitación Total",
       color = "Altitud Media") +
  theme(axis.text.x = element_text(angle = 90, hjust =1, size = 6))
```

### 4.5 Filtración de datos
```{r Filtracion}
combinados<- inner_join(defuncion_resp_total, zonas_verdes, by = "Provincia")
datatable(combinados)
```


### 4.6 Visualizacion % zonas verdes y Defunciones por cada provincia
```{r}
ggplot(data = combinados, aes(x = `Parques m²/hab`, y =defunciones))+
  geom_point(aes(colour = Provincia))+
  geom_smooth(colour = "black")+#linea de tendencia
  labs(x = "Porcentaje zonas verdes", y = "Numero de defunciones")
```

### 4.7 Filtración hospitales con la cantidad de zonas verdes
```{r Combinación cantidad de hospitales y zonas}
conteo_por_provincia <- datos %>%
  group_by(Provincia) %>%
  summarize(Numero_Hospitales = n_distinct(`Nombre Centro`))

# Combinamos datos
datos_combinados <- inner_join(conteo_por_provincia, zonas_verdes, by = "Provincia")

# Filtramos por la cantidad de zonas verdes que sea mayor a 5.
datos_filtrados <- datos_combinados %>%
  filter(`Parques m²/hab` > 5)

# Mostramos el resultado
datatable(datos_filtrados)

```

###4.8 Gráfico de dispersión de nº de hospitales por la cantidad de zonas verdes
```{r Gráfico de dispersión de nº de hospitales por la cantidad de zonas verdes}
# Gráfico de dispersión
ggplot(datos_filtrados, aes(x =reorder(`Parques m²/hab`, - Numero_Hospitales), y = Numero_Hospitales)) +
  geom_point(color = "red") +
  labs(title = "Relación entre Zonas Verdes y Número de Hospitales por Provincia",
       x = "Zonas Verdes (m^2/habitante)",
       y = "Número de Hospitales") +
  theme_minimal()

```
### 4.9 Gráfico de barras apiladas de nº de hospitales con cantidad de zonas verdes.
```{r Gráfico de barras apiladas de nº de hospitales con cantidad de zonas verdes.}
ggplot(datos_filtrados, aes(x = Provincia)) +
  geom_bar(aes(y = `Parques m²/hab`, fill = "Zonas Verdes"), stat = "identity") +
  geom_bar(aes(y = Numero_Hospitales, fill = "Hospitales"), stat = "identity") +
  labs(title = "Zonas Verdes y Hospitales por Provincia",
       x = "Provincia",
       y = "Cantidad") +
  scale_fill_manual(values = c("Zonas Verdes" = "green", "Hospitales" = "blue"))

```
### 4.9 Gráfico de violín que relaciona nº de hospitales con cantidad de zonas verdes.

```{r Gráfico de violín que relaciona nº de hospitales con cantidad de zonas verdes.}
#Muestra la densidad de las observaciones en diferentes niveles de las variables.
ggplot(datos_filtrados, aes(x = factor(1), y = `Parques m²/hab`)) +
  geom_violin(fill = "green", alpha = 0.7) +
  geom_violin(aes(x = factor(2), y = Numero_Hospitales), fill = "blue", alpha = 0.7) +
  labs(title = "Distribución de Zonas Verdes y Hospitales por Provincia",
       x = "",
       y = "Cantidad") +
  scale_x_discrete(labels = c("Zonas Verdes", "Hospitales"))

```



