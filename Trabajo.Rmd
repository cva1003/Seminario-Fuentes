---
title: "¿Existe una relación entre las defunciones por enfermedad respiratoria, el tiempo meteorológico y la cantidad de zonas verdes?"
author: "Claudia Valentín, Nisrine Fariss, Jacinto Javier Perez"
date: "`r Sys.Date()`"
output: 
  html_document:
    fig_width: 20 
    fig_height: 6
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Indice de contenidos
1. Introducción
2. Objetivos
3. Conjunto de datos
4. Desarrollo y Resultados
5. Conclusiones finales

## 1.Introducción
La superficie de zonas verdes en España y en el mundo han ido disminuyendo, siendo sustiyuendo estas superficies por construcción de infraestructuras, carreteras, desarollo urbano, etc...

Estas zonas verdes ayudan a la eliminacion de gases atmosfericos, por lo que al eliminarlas o reducirlas percute en nuestra salud y ademas la cantidad de estas zonas influyen en la regulación del clima.

## 2.Objetivos
El objetivo principal de nuestro proyecto es determinar una posible relación entre las defunciones por enfermedades respiratorias y el medio ambiente.

Tambien vamos a comparar los resultados con la cantidad de centros de salud para contrastar si tambien es un problema por falta de medios sanitarios o solo medioambientales

## 3.Conjunto de datos
Hemos recogido datos de bases de datos diferentes, entre ellas encontramos la aemet, el ine, el ministerio de sanidad y el diario AS.

Vamos a trabajar con ellos en el formato .xlsx

## 4.Desarrollo y Resultados
En primer lugar, vamos a realizar una exposición principal de todos los datos recabados para luego modificarlos y trabajar con ellos.

**Importación de librerias**
```{r librerias, echo=TRUE}
library(readxl)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(climaemet)
library(lubridate)

```
### 4.1Datos de defunciones por enfermedades respiratorias
```{r defunciones, echo=TRUE}
defuncion <-read_excel("defunciones.xlsx")
defuncion_resp<-defuncion %>%
  slice(1337:1500)%>%
  select(1,3)%>%
  rename(Provincia = 1, defunciones= 2)
datable(defuncion_resp)

```
#### 4.1.1 Datos de defunciones por enfermedades respiratorias total por Provincia
```{r defunciones total, echo=TRUE}
defuncion_resp_total<-defuncion_resp %>%
  slice(2:53)%>%
  select(1,2)
defuncion_resp_total
knitr::kable(defuncion_resp_total)

```
#### 4.1.2 Datos de defunciones por enfermedades respiratorias mujeres por Provincia
```{r defunciones mujeres, echo=TRUE}
defuncion_resp_mujeres<-defuncion_resp %>%
  slice(112:163)%>%
  select(1,2)%>%
  rename(defunciones_mujeres= 2)
knitr::kable(defuncion_resp_mujeres)
```
#### 4.1.3 Datos de defunciones por enfermedades respiratorias hombres por Provincia
```{r defunciones hombres, echo=TRUE}

defuncion_resp_hombres<-defuncion_resp %>%
  slice(57:108)%>%
  select(1,2)%>%
  rename(defunciones_hombres= 2)

knitr::kable(defuncion_resp_hombres)
```

#### 4.1.4 Histograma de defunciones por enfermedades respiratorias de hombres y mujeres por Provincia
```{r}
# combinar
defuncion_resp_combinada <- merge(defuncion_resp_hombres, defuncion_resp_mujeres, by = "Provincia")
ggplot(defuncion_resp_combinada, aes(x = Provincia)) +
  geom_bar(aes(y = defunciones_hombres, fill = "Hombres"), position = "dodge", stat = "identity") +
  geom_bar(aes(y = defunciones_mujeres, fill = "Mujeres"), position = "dodge", stat = "identity") +
  labs(title = "Defunciones por enfermedades respiratorias por provincia",
       x = "Provincia",
       y = "Defunciones",
       fill = "Género") +
  scale_fill_manual(values = c("Hombres" = "white", "Mujeres" = "purple"))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  

```

### 4.2 Importación de datos de la cantidad de zonas verdes
```{r}
zonas_verdes <- read_excel("zonas_verdes.xlsx")
zonas_verdes

```

### Grafico zonas verdes
```{r}
ggplot(zonas_verdes, aes(x = Provincia, y = `Parques m²/hab`)) +
  geom_bar(stat = "identity", fill = "darkgreen", alpha = 0.7) +
  labs(title = "Zonas verdes", x = "Provincia", y = "m^2/habitante") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  


```


### 4.3 Número de hospitales por provincia.

```{r conteo por provincia}
datos <-read_excel("CNH_2021.xlsx")
conteo_por_provincia <- datos %>%
  group_by(Provincia) %>%
  summarize(Numero_Hospitales = n_distinct(`Nombre Centro`))
knitr::kable(conteo_por_provincia)
```

#### 4.3.1 Gráfico de barras del número de hospitales por provincia

```{r grafico}
conteo_por_provincia$Provincia <- substr(conteo_por_provincia$Provincia, 1,3)

ggplot(conteo_por_provincia, aes(x = Provincia, y = Numero_Hospitales)) +
  geom_bar(stat = "identity", fill = "green") +
  labs(title = "Número de Hospitales por Provincia",
       x = "Provincia",
       y = "Número de Hospitales") +
  theme_minimal()

```

### 4.4 Lluvias por provincia
```{r Lluvias por provincia}
#aemet_api_key("eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJjbGF1ZGlhdmFsZ3VAZ21haWwuY29tIiwianRpIjoiMTU3MmFlYmMtNDU0My00ZjJiLTgyYjgtY2M0NTI2NWY2YTNmIiwiaXNzIjoiQUVNRVQiLCJpYXQiOjE2OTkyNjIzMDUsInVzZXJJZCI6IjE1NzJhZWJjLTQ1NDMtNGYyYi04MmI4LWNjNDUyNjVmNmEzZiIsInJvbGUiOiIifQ.X2uwTqNh9qDeaoVJSlEgO4oCN_YpqRAVRlgxsV0BUtU",install=TRUE, overwrite = TRUE)
estaciones<- aemet_stations()
colnames(estaciones)
levels(estaciones$provincia)
valores_unicos <- unique(estaciones$provincia)
valores_unicos
summary(estaciones)
estaciones
```

```{r}
vector_resultado <- estaciones$indicativo
vector_resultado

```

```{r Lluvias por provincias}
#datos climatogicos por cada estacion en cada provincia
data_monthlysi <- aemet_monthly_clim(station=estaciones$indicativo, year = 2022)
data_monthlysi
summary(data_monthlysi)
colnames(data_monthlysi)
str(data_monthlysi)

```
```{r}
data_monthlysi
str(data_monthlysi)
#promedio de lluvias por cada estacion
data_monthlyprom <- data_monthlysi %>%
  group_by(indicativo) %>%
  summarize(promedio_precipitacion = mean(p_mes, na.rm = TRUE))
data_monthlyprom#son litros/m^2
```

### Asociacion a cada provincias
```{r}
resultado <- dplyr::left_join(data_monthlyprom, estaciones, by = "indicativo") %>%
  dplyr::select(indicativo, provincia, everything())
resultado
```

### Agrupacion por provincia
```{r}
# Seleccionar un rango de columnas
datos_interes <- resultado %>% group_by(provincia)%>%
  select(indicativo, provincia, altitud, promedio_precipitacion )
datos_interes
```


```{r}
#obtencion datos para el grafico
datos_grafico<- datos_interes%>% group_by(provincia)%>%
summarize(altitu_media = mean(altitud, na.rm = TRUE),
    precip_total = sum(promedio_precipitacion, na.rm = TRUE))
datos_grafico
```

### Grafico de precipitaciones
```{r}
ggplot(datos_grafico, aes(x = provincia, y = precip_total, color = altitu_media)) +
  geom_point(size = 3) +
  scale_color_gradient(low = "blue", high = "red") +
  labs(title = "Precipitación y altitud por provincia",
       x = "Provincia",
       y = "Precipitación Total",
       color = "Altitud Media") +
  theme(axis.text.x = element_text(angle = 90, hjust =1, size = 6))
```

### 4.5 Filtración de datos
```{r Filtracion}
defuncion_resp_total
zonas_verdes1
summary(defuncion_resp_total)
summary(zonas_verdes1)
defuncion_resp_total$Provincia <- as.factor(defuncion_resp_total$Provincia)
zonas_verdes1$Provincia <- as.factor(zonas_verdes1$Provincia)
levels(defuncion_resp_total$Provincia)
levels(zonas_verdes1$Provincia)
combinados<- inner_join(defuncion_resp_total, zonas_verdes1, by = "Provincia")


knitr::kable(combinados)# paquete DT CAMBIAR https://rstudio.github.io/DT/
```

### 4.6 Visualizacion % zonas verdes y Defunciones por cada provincia
```{r Grafico}
ggplot(data = combinados, aes(x = `Parques m²/hab`, y =defunciones))+
  geom_point(aes(colour = Provincia))+
  geom_smooth(colour = "black")+#linea de tendencia
  labs(x = "Porcentaje zonas verdes", y = "Numero de defunciones")
```

### 4.7 Filtración hospitales con la cantidad de zonas verdes
```{r Combinación cantidad de hospitales y zonas}
datos_combinados <- left_join(datos_hospitales, zonas_verdes, by = "Provincia")
# Por ejemplo, filtra hospitales con más de 5 m² de zonas verdes por habitante
hospitales_con_zonas_verdes <- datos_combinados %>%
  filter(`Parques m²/hab` > 5)
print(hospitales_con_zonas_verdes)
```

